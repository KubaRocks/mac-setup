---
- hosts: local
  connection: local

  vars_files:
    - vars/main.yml

  tasks:
    - name: Get list of tapped repositories.
      command: brew tap
      register: homebrew_tap_list

    - name: Tap required repositories
      command: brew tap {{ item }}
      with_items: "{{ homebrew_taps }}"
      when: "'{{ item }}' not in homebrew_tap_list.stdout"

    - name: Get list of installed homebrew packages.
      command: brew list
      register: homebrew_list
      changed_when: false

    - name: Get list of apps installed with cask.
      command: brew cask list
      register: homebrew_cask_list
      changed_when: false

    - name: Install apps via `brew cask`.
      command: brew cask install {{ item }}
      with_items: "{{ homebrew_cask_apps }}"
      when: "'{{ item }}' not in homebrew_cask_list.stdout"

    - name: Install configured homebrew packages.
      command: "brew install {{ item }}"
      with_items: "{{ homebrew_installed_packages }}"
      when: "'{{ item }}' not in homebrew_list.stdout"

    - name: Install npm ecosystem
      npm: name={{ item }} global=yes state=present
      with_items: "{{ npm_packages }}"

    - name: Install gem ecosystem
      gem: name={{ item }} global=yes state=present
      with_items: "{{ gem_packages }}"
